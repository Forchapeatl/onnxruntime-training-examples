FROM rocm/pytorch:rocm4.3.1_ubuntu18.04_py3.6_pytorch_1.8.1
ENV ROCM_HOME=/opt/rocm

# Install and update tools to minimize security vulnerabilities
RUN apt-get update
RUN apt-get install -y software-properties-common wget apt-utils patchelf git libprotobuf-dev protobuf-compiler cmake unattended-upgrades
RUN apt-get autoremove -y

# ORT Module
ARG ORT_CACHE_DATE=10-06-2021
RUN CC=mpicc MPICC=mpicc pip install mpi4py --no-binary mpi4py
RUN pip install onnx ninja
RUN pip install --pre onnxruntime-training -f https://onnxruntimepackages.z14.web.core.windows.net/onnxruntime_stable_rocm431.html
RUN pip install torch-ort

WORKDIR /stage

# Huggingface-Transformers
RUN pip install azureml-defaults wget fairscale 
RUN pip install datasets==1.9.0 sacremoses sacrebleu==1.5.1 sentencepiece scipy sklearn
RUN git clone https://github.com/microsoft/huggingface-transformers.git &&\
    cd huggingface-transformers && git checkout superbench/rocm &&\
    pip install -e .

# Benchmarking scripts
RUN git clone https://github.com/microsoft/onnxruntime-training-examples.git &&\
    cd onnxruntime-training-examples && git checkout rocm/superbench 

# Entry script should launch 
RUN mkdir -p /logs
ENTRYPOINT ["/bin/bash", "/stage/onnxruntime-training-examples/huggingface/azureml/run_benchmark.sh"]
